import java.io.*;
import java.nio.file.*;
import java.util.*;
import java.util.stream.Collectors;

public class InventoryService {

    public void initDataDirectory(Path dir) throws IOException {
        if (!Files.exists(dir)) {
            Files.createDirectories(dir);
        }
    }

    public List<Product> loadProducts(Path csvPath) throws IOException {
        List<Product> products = new ArrayList<>();
        if (!Files.exists(csvPath)) return products;

        try (BufferedReader reader = Files.newBufferedReader(csvPath)) {
            String line = reader.readLine(); // skip header
            while ((line = reader.readLine()) != null) {
                products.add(Product.fromCsvLine(line));
            }
        }
        return products;
    }

    public void saveProducts(List<Product> products, Path csvPath) throws IOException {
        try (BufferedWriter writer = Files.newBufferedWriter(csvPath)) {
            writer.write("id,name,category,price,quantity");
            writer.newLine();
            for (Product p : products) {
                writer.write(p.toCsvLine());
                writer.newLine();
            }
        }
    }

    public List<Product> searchProducts(List<Product> products, String keyword) {
        return products.stream()
            .filter(p -> p.getName().toLowerCase().contains(keyword.toLowerCase()))
            .collect(Collectors.toList());
    }

    public void sortProducts(List<Product> products, String criteria) {
        if ("price".equalsIgnoreCase(criteria)) {
            products.sort(Comparator.comparingDouble(Product::getPrice));
        } else if ("quantity".equalsIgnoreCase(criteria)) {
            products.sort(Comparator.comparingInt(Product::getQuantity));
        }
    }

    public List<Product> filterByPrice(List<Product> products, double min, double max) {
        return products.stream()
            .filter(p -> p.getPrice() >= min && p.getPrice() <= max)
            .collect(Collectors.toList());
    }

    public void runMenu(List<Product> products) throws IOException {
        Scanner sc = new Scanner(System.in);
        boolean running = true;
        while (running) {
            System.out.println("\n=== INVENTORY MANAGER ===");
            System.out.println("1. Lihat semua");
            System.out.println("2. Tambah produk");
            System.out.println("3. Update stok");
            System.out.println("4. Hapus produk");
            System.out.println("5. Cari produk");
            System.out.println("6. Sort produk");
            System.out.println("7. Filter harga");
            System.out.println("8. Simpan & Keluar");
            System.out.print("Pilih: ");
            String choice = sc.nextLine();

            switch (choice) {
                case "1": viewAll(products); break;
                case "2": addProduct(products, sc); break;
                case "3": updateQuantity(products, sc); break;
                case "4": deleteProduct(products, sc); break;
                case "5":
                    System.out.print("Keyword: ");
                    List<Product> found = searchProducts(products, sc.nextLine());
                    viewAll(found);
                    break;
                case "6":
                    System.out.print("Sort by (price/quantity): ");
                    sortProducts(products, sc.nextLine());
                    viewAll(products);
                    break;
                case "7":
                    System.out.print("Min harga: ");
                    double min = Double.parseDouble(sc.nextLine());
                    System.out.print("Max harga: ");
                    double max = Double.parseDouble(sc.nextLine());
                    viewAll(filterByPrice(products, min, max));
                    break;
                case "8": running = false; break;
                default: System.out.println("Pilihan tidak valid.");
            }
        }
    }

    private void viewAll(List<Product> products) {
        System.out.printf("%-4s %-20s %-10s %-10s %-10s\n", "ID", "Name", "Category", "Price", "Qty");
        for (Product p : products) {
            System.out.printf("%-4d %-20s %-10s %-10.2f %-10d\n",
                    p.getId(), p.getName(), p.getCategory(), p.getPrice(), p.getQuantity());
        }
    }

    private void addProduct(List<Product> products, Scanner sc) {
        System.out.print("ID: ");
        int id = Integer.parseInt(sc.nextLine());
        System.out.print("Name: ");
        String name = sc.nextLine();
        System.out.print("Category: ");
        String category = sc.nextLine();
        System.out.print("Price: ");
        double price = Double.parseDouble(sc.nextLine());
        System.out.print("Quantity: ");
        int qty = Integer.parseInt(sc.nextLine());
        products.add(new Product(id, name, category, price, qty));
        System.out.println("Produk ditambahkan.");
    }

    private void updateQuantity(List<Product> products, Scanner sc) {
        System.out.print("ID produk: ");
        int id = Integer.parseInt(sc.nextLine());
        for (Product p : products) {
            if (p.getId() == id) {
                System.out.print("Stok baru: ");
                p.setQuantity(Integer.parseInt(sc.nextLine()));
                System.out.println("Stok diperbarui.");
                return;
            }
        }
        System.out.println("Produk tidak ditemukan.");
    }

    private void deleteProduct(List<Product> products, Scanner sc) {
        System.out.print("ID produk yang ingin dihapus: ");
        int id = Integer.parseInt(sc.nextLine());
        products.removeIf(p -> p.getId() == id);
        System.out.println("Produk dihapus jika ditemukan.");
    }
}
